{% extends "clinic/base.html" %}
{% block title %}Kalendar i Takimeve{% endblock %}
{% block content %}

<div class="mb-4 flex items-center justify-between">
  <h2 class="text-xl font-semibold flex items-center gap-2">
    <span>ðŸ“…</span> Kalendar i Takimeve
  </h2>

  <!-- Filtrim sipas doktorit -->
  <div class="flex items-center gap-2">
    <label for="doctorFilter" class="text-sm text-gray-600">Filtro sipas doktorit:</label>
    <select id="doctorFilter" class="border rounded p-2 text-sm">
      <option value="">TÃ« gjithÃ«</option>
      <option value="Dr. Labi">Dr. Labi</option>
      <option value="Dr. Linda">Dr. Linda</option>
    </select>
  </div>
</div>

<!-- Kalendar -->
<div id="calendar" class="bg-white border rounded-lg shadow p-3"></div>

<!-- FullCalendar CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<!-- MODAL pÃ«r krijimin/editimin e takimit -->
<div id="appointmentModal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 relative">
    <h3 class="text-lg font-semibold mb-4">âž• Takim i Ri</h3>

    <form id="appointmentForm" class="space-y-4">
      {% csrf_token %}
      <input type="hidden" id="apptId">

      <div>
        <label class="text-sm">Pacienti</label>
        <select id="apptPatient" class="border rounded w-full p-2" required>
          <option value="">-- Zgjidh pacientin --</option>
          {% for p in patients %}
            <option value="{{ p.id }}">{{ p.emri_mbiemri }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="text-sm">Doktori</label>
        <select id="apptDoctor" class="border rounded w-full p-2" required>
          <option value="Dr. Labi">Dr. Labi</option>
          <option value="Dr. Linda">Dr. Linda</option>
        </select>
      </div>

      <div>
        <label class="text-sm">ShÃ«rbimi / Arsyeja</label>
        <input id="apptService" class="border rounded w-full p-2" placeholder="p.sh. Kontroll, Ekstraksion..." required>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-sm">Data & Ora e fillimit</label>
          <input type="datetime-local" id="apptStart" class="border rounded w-full p-2" required>
        </div>
        <div>
          <label class="text-sm">Ora e mbarimit (opsionale)</label>
          <input type="datetime-local" id="apptEnd" class="border rounded w-full p-2">
        </div>
      </div>

      <div>
        <label class="text-sm">Statusi</label>
        <select id="apptStatus" class="border rounded w-full p-2">
          <option value="scheduled">Planifikuar</option>
          <option value="completed">PÃ«rfunduar</option>
          <option value="cancelled">Anuluar</option>
        </select>
      </div>

      <div>
        <label class="text-sm">ShÃ«nime</label>
        <textarea id="apptNotes" rows="2" class="border rounded w-full p-2"></textarea>
      </div>

      <div class="flex justify-end gap-2 pt-3">
        <button type="button" id="btnCloseModal" class="px-4 py-2 border rounded bg-gray-100">Mbyll</button>
        <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded">Ruaj</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const calendarEl = document.getElementById("calendar");
    const modal = document.getElementById("appointmentModal");
    const form = document.getElementById("appointmentForm");

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay,listWeek"
      },
      locale: "sq",
      selectable: true,
      editable: true,
      height: "auto",
      events: "/appointments/events/",

      // kur zgjedh njÃ« ditÃ«/slot
      select: function(info) {
        let startDate = new Date(info.start);

        // nÃ«se Ã«shtÃ« zgjedhur vetÃ«m dita (allDay = true), vendos orÃ«n 09:00
        if (info.allDay) {
          startDate.setHours(9, 0, 0, 0);
        }

        // pÃ«rgatit ISO string pÃ«r datetime-local
        let localStart = startDate.toISOString().slice(0,16);

        // auto +30 min pÃ«r ora mbarimi
        let endDate = new Date(startDate);
        endDate.setMinutes(endDate.getMinutes() + 30);
        let localEnd = endDate.toISOString().slice(0,16);

        openModal({
          start: localStart,
          end: localEnd
        });
      },

      eventClick: function(info) {
        openModal({
          id: info.event.id,
          patient: info.event.extendedProps.patient_id,
          doctor: info.event.extendedProps.doctor,
          title: info.event.extendedProps.service,
          start: info.event.start ? info.event.start.toISOString().slice(0,16) : "",
          end: info.event.end ? info.event.end.toISOString().slice(0,16) : "",
          status: info.event.extendedProps.status,
          notes: info.event.extendedProps.notes
        });
      },

      eventDrop: function(info) { updateEvent(info.event); },
      eventResize: function(info) { updateEvent(info.event); }
    });

    calendar.render();

    // modal open
    function openModal(data={}) {
      document.getElementById("apptId").value = data.id || "";
      document.getElementById("apptPatient").value = data.patient || "";
      document.getElementById("apptDoctor").value = data.doctor || "Dr. Labi";
      document.getElementById("apptService").value = data.title || "";
      document.getElementById("apptStart").value = data.start || "";
      document.getElementById("apptEnd").value = data.end || "";
      document.getElementById("apptStatus").value = data.status || "scheduled";
      document.getElementById("apptNotes").value = data.notes || "";

      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    // mbyll modal
    document.getElementById("btnCloseModal").addEventListener("click", () => {
      modal.classList.add("hidden");
    });

    // submit
    form.addEventListener("submit", function(e) {
      e.preventDefault();

      const id = document.getElementById("apptId").value;
      const payload = {
        patient: document.getElementById("apptPatient").value,
        doctor: document.getElementById("apptDoctor").value,
        title: document.getElementById("apptService").value,
        start: document.getElementById("apptStart").value,
        end: document.getElementById("apptEnd").value,
        status: document.getElementById("apptStatus").value,
        notes: document.getElementById("apptNotes").value
      };

      fetch(id ? `/appointments/update/${id}/` : "/appointments/create/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify(payload)
      }).then(() => {
        modal.classList.add("hidden");
        calendar.refetchEvents();
      });
    });

    // update
    function updateEvent(event) {
      fetch(`/appointments/update/${event.id}/`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
        body: JSON.stringify({
          start: event.start.toISOString(),
          end: event.end ? event.end.toISOString() : null
        })
      }).then(() => calendar.refetchEvents());
    }

    // filtrimi sipas doktorit
    document.getElementById("doctorFilter").addEventListener("change", function() {
      const doctor = this.value;
      calendar.removeAllEvents();
      calendar.addEventSource((fetchInfo, successCallback, failureCallback) => {
        fetch("/appointments/events/")
          .then(res => res.json())
          .then(events => {
            if (doctor) {
              events = events.filter(e => e.extendedProps && e.extendedProps.doctor === doctor);
            }
            successCallback(events);
          });
      });
    });
  });
</script>

{% endblock %}
