{% extends "clinic/base.html" %}
{% block title %}Kalendar i Termineve{% endblock %}
{% block content %}
{% load static %}

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
  /* --- Stil Klinik Minimal --- */
  body { font-family: 'Inter', sans-serif; }
  .fc {
    --fc-border-color: #e5e7eb;
    --fc-today-bg-color: #f8fafc;
    --fc-button-bg-color: #10b981;
    --fc-button-hover-bg-color: #059669;
    --fc-button-active-bg-color: #047857;
    --fc-button-text-color: #fff;
  }
  .fc-toolbar-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
  }
  .fc-event {
    border: none !important;
    border-radius: 6px !important;
    font-size: 0.85rem;
    padding: 2px 6px;
  }
  /* ngjyrat p√´r pamjet e dit√´s (timeGrid) */
  .fc-view-timeGridDay .fc-event.scheduled { background-color: #10b981 !important; color: #fff !important; }
  .fc-view-timeGridDay .fc-event.completed { background-color: #2563eb !important; color: #fff !important; }
  .fc-view-timeGridDay .fc-event.cancelled { background-color: #ef4444 !important; color: #fff !important; }

  /* pamja e list√´s (listWeek) - pa ngjyra */
  .fc-view-listWeek .fc-event {
    background-color: #ffffff !important;
    border: 1px solid #e5e7eb !important;
    color: #111827 !important;
    border-radius: 8px !important;
    transition: all 0.15s ease-in-out;
  }
  .fc-view-listWeek .fc-event:hover {
    background-color: #f9fafb !important;
    transform: scale(1.01);
  }
</style>

<div class="flex flex-col gap-4">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h2 class="text-2xl font-semibold text-gray-800 flex items-center gap-2">
        <span class="text-emerald-600">üóìÔ∏è</span> Kalendar i Termineve
      </h2>
      <p class="text-sm text-gray-500">Orari i pun√´s: <span class="font-medium text-gray-700">09:00 ‚Äì 20:00</span></p>
    </div>
    <button id="addNew"
      class="px-5 py-2 bg-emerald-600 text-white rounded-lg text-sm shadow hover:bg-emerald-700 transition flex items-center gap-2">
      <i class="ph ph-plus"></i> Shto Termin
    </button>
  </div>

  <!-- Calendar -->
  <div id="calendar" class="bg-white rounded-xl border border-gray-200 shadow-sm p-3"></div>
</div>

<!-- MODAL -->
<div id="appointmentModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative animate-fade-in">
    <h3 id="modalTitle" class="text-lg font-semibold text-gray-800 mb-4">Termin i Ri</h3>
    <form id="appointmentForm" class="space-y-4">
      <input type="hidden" id="apptId">

      <!-- AUTOCOMPLETE Pacienti -->
      <div class="relative">
        <label class="text-sm text-gray-600">Pacienti</label>
        <input id="apptPatientInput"
              type="text"
              class="border rounded-lg w-full p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500"
              placeholder="Shkruaj emrin ose numrin e pacientit..."
              autocomplete="off" required>
        <input type="hidden" id="apptPatient"> <!-- ID ruhet k√´tu -->
        <ul id="patientSuggestions"
            class="absolute z-10 bg-white border rounded-lg mt-1 w-full shadow hidden max-h-48 overflow-y-auto text-sm"></ul>
      </div>

      <div>
        <label class="text-sm text-gray-600">Doktori</label>
        <select id="apptDoctor" class="border rounded-lg w-full p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500" required>
          <option value="Dr. Labi">Dr. Labi</option>
          <option value="Dr. Linda">Dr. Linda</option>
        </select>
      </div>

      <div>
        <label class="text-sm text-gray-600">Sh√´rbimi / Arsyeja</label>
        <input id="apptTitle" type="text" class="border rounded-lg w-full p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500"
               placeholder="p.sh. Kontroll, Ekstraksion..." required>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-gray-600">Fillimi</label>
          <input id="apptStart" type="datetime-local" class="border rounded-lg w-full p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500" required>
        </div>
        <div>
          <label class="text-sm text-gray-600">Mbarimi</label>
          <input id="apptEnd" type="datetime-local" class="border rounded-lg w-full p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
        </div>
      </div>

      <div>
        <label class="text-sm text-gray-600">Statusi</label>
        <select id="apptStatus" class="border rounded-lg w-full p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
          <option value="scheduled">Planifikuar</option>
          <option value="completed">P√´rfunduar</option>
          <option value="cancelled">Anuluar</option>
        </select>
      </div>

      <div>
        <label class="text-sm text-gray-600">Sh√´nime</label>
        <textarea id="apptNotes" rows="2" class="border rounded-lg w-full p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500"></textarea>
      </div>

      <div class="flex justify-between pt-3">
        <button type="button" id="btnDelete" class="text-red-600 text-sm hidden hover:underline">Fshij</button>
        <div class="flex gap-2">
          <button type="button" id="btnCancel" class="px-3 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition">Anulo</button>
          <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm hover:bg-emerald-700 transition">Ruaj</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const modal = document.getElementById("appointmentModal");
  const form = document.getElementById("appointmentForm");
  const btnCancel = document.getElementById("btnCancel");
  const btnDelete = document.getElementById("btnDelete");
  const modalTitle = document.getElementById("modalTitle");
  const btnNew = document.getElementById("addNew");

  function openModal(data = {}) {
    modal.classList.remove("hidden");
    modal.classList.add("flex");
    modalTitle.textContent = data.id ? "‚úèÔ∏è Ndrysho Termin" : "‚ûï Termin i Ri";
    btnDelete.classList.toggle("hidden", !data.id);

    document.getElementById("apptId").value = data.id || "";
    document.getElementById("apptPatient").value = data.patient || "";
    document.getElementById("apptPatientInput").value = data.patient_name || "";
    document.getElementById("apptDoctor").value = data.doctor || "Dr. Labi";
    document.getElementById("apptTitle").value = data.title || "";
    document.getElementById("apptStart").value = data.start || "";
    document.getElementById("apptEnd").value = data.end || "";
    document.getElementById("apptStatus").value = data.status || "scheduled";
    document.getElementById("apptNotes").value = data.notes || "";
  }

  function closeModal() { modal.classList.add("hidden"); }

  const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
    initialView: "timeGridDay",
    locale: "sq",
    firstDay: 1, // fillon me e h√´n√´
    hiddenDays: [0], // fsheh t√´ diel√´n (0 = Sunday)
    slotMinTime: "09:00:00",
    slotMaxTime: "20:00:00",
    allDaySlot: false,
    height: "auto",
    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: "timeGridDay,listWeek"
    },
    dayHeaderFormat: { weekday: 'long' },
    slotLabelFormat: {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    },
    slotLabelContent: function(arg) {
      return "Ora: " + arg.text;
    },
    selectable: true,
    editable: true,
    events: "/appointments/events/",
    eventContent: function(info) {
      let title = info.event.title || "";
      let doctor = info.event.extendedProps.doctor ? " (" + info.event.extendedProps.doctor + ")" : "";
      return { html: `<b>${title}</b>${doctor}` };
    },
    eventClassNames: function(info) {
      return info.event.extendedProps.status;
    },
    eventClick: (info) => openModal({
      id: info.event.id,
      patient: info.event.extendedProps.patient,
      patient_name: info.event.extendedProps.patient_name,
      doctor: info.event.extendedProps.doctor,
      title: info.event.title,
      start: info.event.startStr.slice(0,16),
      end: info.event.endStr ? info.event.endStr.slice(0,16) : "",
      status: info.event.extendedProps.status,
      notes: info.event.extendedProps.notes
    }),
    select: (info) => openModal({
      start: info.startStr.slice(0,16),
      end: info.endStr ? info.endStr.slice(0,16) : ""
    }),
    eventDrop: (info) => updateEvent(info.event),
    eventResize: (info) => updateEvent(info.event)
  });
  calendar.render();

  // Autocomplete p√´r pacientin ekzistues
  const patientInput = document.getElementById("apptPatientInput");
  const patientHidden = document.getElementById("apptPatient");
  const suggestions = document.getElementById("patientSuggestions");

  patientInput.addEventListener("input", async function() {
    const query = this.value.trim();
    if (!query) {
      suggestions.classList.add("hidden");
      return;
    }

    try {
      const res = await fetch(`/patients/search/?q=${encodeURIComponent(query)}`);
      const data = await res.json();

      suggestions.innerHTML = "";
      data.forEach(p => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${p.emri_mbiemri}</strong> <span class="text-gray-500 text-xs">(${p.telefoni || "pa num√´r"})</span>`;
        li.className = "px-3 py-2 hover:bg-emerald-50 cursor-pointer";
        li.onclick = () => {
          patientInput.value = p.emri_mbiemri;
          patientHidden.value = p.id;
          suggestions.classList.add("hidden");
        };
        suggestions.appendChild(li);
      });

      if (data.length > 0) suggestions.classList.remove("hidden");
      else suggestions.classList.add("hidden");
    } catch (err) {
      console.error("Gabim gjat√´ k√´rkimit:", err);
    }
  });

  document.addEventListener("click", (e) => {
    if (!patientInput.contains(e.target) && !suggestions.contains(e.target)) {
      suggestions.classList.add("hidden");
    }
  });

  btnNew.addEventListener("click", () => openModal());

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const id = document.getElementById("apptId").value;
    const payload = {
      patient: document.getElementById("apptPatient").value,
      doctor: document.getElementById("apptDoctor").value,
      title: document.getElementById("apptTitle").value,
      start: document.getElementById("apptStart").value,
      end: document.getElementById("apptEnd").value,
      status: document.getElementById("apptStatus").value,
      notes: document.getElementById("apptNotes").value
    };

    fetch(id ? `/appointments/update/${id}/` : "/appointments/create/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    }).then(() => {
      closeModal();
      calendar.refetchEvents();
    });
  });

  btnDelete.addEventListener("click", () => {
    const id = document.getElementById("apptId").value;
    fetch(`/appointments/delete/${id}/`, { method: "POST" })
      .then(() => { closeModal(); calendar.refetchEvents(); });
  });

  btnCancel.addEventListener("click", closeModal);
});
</script>
{% endblock %}
