{% extends "clinic/base.html" %}
{% block title %}{% if historia %}Edito histori{% else %}Shto histori{% endif %} – {{ patient.emri_mbiemri }}{% endblock %}
{% block content %}

<!-- Header -->
<div class="mb-5 flex items-center justify-between">
  <h2 class="text-xl font-semibold tracking-tight">
    {% if historia %}Edito histori{% else %}Shto histori{% endif %} për: {{ patient.emri_mbiemri }}
  </h2>
  <a href="{% url 'patient_detail' patient.id %}" class="px-3 py-2 border rounded bg-white hover:bg-gray-50 text-sm">Kthehu</a>
</div>

<form method="post" class="bg-white border rounded-xl p-5 md:p-6 space-y-6">
  {% csrf_token %}

  <!-- 1) TË DHËNAT KRYESORE -->
  <section class="space-y-3">
    <h3 class="text-sm font-semibold text-gray-700">Të dhënat kryesore</h3>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label class="block text-xs text-gray-500 mb-1">Data</label>
        <input name="data" type="date"
               value="{{ historia.data|date:'Y-m-d'|default:today }}"
               class="border rounded w-full p-2" />
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Doktori</label>
        <select name="doctor" class="border rounded w-full p-2" required>
          <option value="">-- Zgjidh doktorin --</option>
          <option value="Dr. Labi"  {% if historia and historia.doctor == 'Dr. Labi' %}selected{% endif %}>Dr. Labi</option>
          <option value="Dr. Linda" {% if historia and historia.doctor == 'Dr. Linda' %}selected{% endif %}>Dr. Linda</option>
        </select>
      </div>
      <div class="md:col-span-2">
        <label class="block text-xs text-gray-500 mb-1">Diagnoza</label>
        <input name="diagnoza" value="{{ historia.diagnoza|default_if_none:'' }}"
               class="border rounded w-full p-2" placeholder="p.sh. Caries profunda M2" />
      </div>
      <div class="md:col-span-4">
        <label class="block text-xs text-gray-500 mb-1">Trajtimi</label>
        <textarea name="trajtimi" rows="3" class="border rounded w-full p-2"
                  placeholder="p.sh. Ekstraksion, anestezi lok./ articaine 4% ...">{{ historia.trajtimi|default_if_none:'' }}</textarea>
      </div>
    </div>
  </section>

  <!-- 2) ODONTOGRAM -->
  <section class="space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="text-sm font-semibold text-gray-700">Odontogram (FDI)</h3>
      <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded border bg-gray-50 text-sm">
        <span class="text-gray-500">Dhëmbët:</span>
        <span id="teethBadge" class="font-medium">asnjë</span>
      </div>
    </div>

    <!-- Maxilla -->
    <div>
      <div class="mb-1 text-[11px] text-gray-500">Maxilla (sipër)</div>
      <div class="flex items-center justify-center gap-2">
        <div class="grid grid-cols-8 gap-1" id="upperLeft"></div>
        <div class="w-3 h-1 bg-gray-200 rounded-full"></div>
        <div class="grid grid-cols-8 gap-1" id="upperRight"></div>
      </div>
    </div>

    <!-- Mandibula -->
    <div class="mt-4">
      <div class="mb-1 text-[11px] text-gray-500">Mandibula (poshtë)</div>
      <div class="flex items-center justify-center gap-2">
        <div class="grid grid-cols-8 gap-1" id="lowerLeft"></div>
        <div class="w-3 h-1 bg-gray-200 rounded-full"></div>
        <div class="grid grid-cols-8 gap-1" id="lowerRight"></div>
      </div>
    </div>

    <!-- stile për dhëmbët -->
    <style>
      .tooth-btn{
        display:flex;align-items:center;justify-content:center;
        min-width:38px;height:34px;
        border-radius:10px;border:1px solid #e5e7eb;background:#f9fafb;
        font-size:13px;color:#374151;transition:.15s all;user-select:none;
      }
      .tooth-btn:hover{ background:#f3f4f6; }
      .tooth-btn.active{ background:#10b981;border-color:#059669;color:#fff;font-weight:600; }
      .field-disabled{ opacity:.55; pointer-events:none; }
    </style>

    <!-- vlerat -->
    <input type="hidden" id="dhembiInput" name="dhembi" value="{{ historia.dhembi|default_if_none:'' }}" />
    <input type="text" id="dhembiDisplay" class="border rounded w-full p-2"
           placeholder="p.sh. 11,12,16" value="{{ historia.dhembi|default_if_none:'' }}" readonly />

    <!-- Toolbar -->
    <div class="flex items-center gap-2 pt-1 text-sm">
      <button type="button" id="btnClear" class="px-3 py-1.5 rounded border bg-white hover:bg-gray-50">Pastro</button>
      <button type="button" id="btnInvert" class="px-3 py-1.5 rounded border bg-white hover:bg-gray-50">Inverto</button>
    </div>
  </section>

  <!-- 3) FINANCA (me marrëveshje) -->
  <section class="space-y-3">
    <h3 class="text-sm font-semibold text-gray-700">Financa</h3>

    <!-- Marrëveshja (opsionale) + përfshirja -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="md:col-span-2">
        <label class="block text-xs text-gray-500 mb-1">Marrëveshje (opsionale)</label>
        <select name="agreement_id" id="fldAgreement" class="border rounded w-full p-2">
          <option value="">— pa marrëveshje —</option>
          {% for a in patient.agreements.all %}
            {% if a.status == "active" %}
              <option value="{{ a.id }}">{{ a.title }} — Totali {{ a.total_amount }}€ (Balanca {{ a.balance }}€)</option>
            {% endif %}
          {% endfor %}
        </select>
        <p class="text-[11px] text-gray-500 mt-1">Nëse zgjedh një marrëveshje, mund të shënosh këtë shërbim si të përfshirë (pa çmim të veçantë).</p>
      </div>
      <div class="flex items-center gap-2">
        <input type="checkbox" id="fldIncluded" name="included_in_agreement" value="1"
               class="size-4">
        <label for="fldIncluded" class="text-sm">E përfshirë në marrëveshje (pa çmim)</label>
      </div>
    </div>

    <!-- Fushat e çmimit (çaktivizohen kur është e përfshirë) -->
    <div id="priceRow" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-xs text-gray-500 mb-1">Vlera</label>
        <input name="vlera" id="fldVlera" value="{{ historia.vlera|default_if_none:'' }}" class="border rounded w-full p-2" placeholder="0.00" />
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Paguar</label>
        <input name="paguar" id="fldPaguar" value="{{ historia.paguar|default_if_none:'' }}" class="border rounded w-full p-2" placeholder="0.00" />
      </div>
      <!-- <div>
        <label class="block text-xs text-gray-500 mb-1">Borgji</label>
        <input name="borgji" id="fldBorgji" value="{{ historia.borgji|default_if_none:'' }}" class="border rounded w-full p-2" placeholder="0.00" />
      </div> -->
    </div>

    <p class="text-[11px] text-gray-500">
      Nëse le bosh “Borgji”, do të llogaritet automatikisht si <em>Vlera − Paguar</em>. Kur shënjon “E përfshirë”, këto fusha çaktivizohen.
    </p>
  </section>

  <!-- 4) LABOR / PROTETIKË -->
  <section class="space-y-3">
    <h3 class="text-sm font-semibold text-gray-700">Labor / Protetikë</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-xs text-gray-500 mb-1">Pasqyra e dhëmbit</label>
        <input name="pasqyra_e_dhembit" value="{{ historia.pasqyra_e_dhembit|default_if_none:'' }}" class="border rounded w-full p-2" />
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Tekniku</label>
        <input name="tekniku" value="{{ historia.tekniku|default_if_none:'' }}" class="border rounded w-full p-2" />
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Punim protetikor</label>
        <input name="punim_protetikor" value="{{ historia.punim_protetikor|default_if_none:'' }}" class="border rounded w-full p-2" />
      </div>
    </div>
  </section>

  <!-- 5) VËREJTJE & VEPRIMET -->
  <section class="space-y-3">
    <div>
      <label class="block text-xs text-gray-500 mb-1">Vërejtje</label>
      <input name="verejtje" value="{{ historia.verejtje|default_if_none:'' }}" class="border rounded w-full p-2" />
    </div>
    <div class="flex items-center gap-3">
      <button class="px-4 py-2 bg-emerald-600 text-white rounded">
        {% if historia %}Ruaj ndryshimet{% else %}Ruaj{% endif %}
      </button>
      <a href="{% url 'patient_detail' patient.id %}" class="px-4 py-2 border rounded bg-white hover:bg-gray-50">Anulo</a>
    </div>
  </section>
</form>

<script>
  // --- FDI renditja ---
  const U_LEFT  = [18,17,16,15,14,13,12,11];
  const U_RIGHT = [21,22,23,24,25,26,27,28];
  const L_LEFT  = [38,37,36,35,34,33,32,31];
  const L_RIGHT = [41,42,43,44,45,46,47,48];

  const selected      = new Set();
  const dhembiInput   = document.getElementById('dhembiInput');
  const dhembiDisplay = document.getElementById('dhembiDisplay');
  const badge         = document.getElementById('teethBadge');

  function renderTeeth(containerId, codes){
    const el = document.getElementById(containerId);
    const frag = document.createDocumentFragment();
    codes.forEach(code=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'tooth-btn';
      b.textContent = code;
      b.dataset.code = String(code);
      b.addEventListener('click', ()=>toggle(b));
      frag.appendChild(b);
    });
    el.appendChild(frag);
  }

  function toggle(btn){
    const code = btn.dataset.code;
    if(selected.has(code)){ selected.delete(code); btn.classList.remove('active'); }
    else { selected.add(code); btn.classList.add('active'); }
    sync();
  }

  function sync(){
    const arr = Array.from(selected).map(Number).sort((a,b)=>a-b);
    const val = arr.join(',');
    dhembiInput.value = val;
    dhembiDisplay.value = val;
    badge.textContent = val || 'asnjë';
  }

  // Rendero rreshtat
  renderTeeth('upperLeft',  U_LEFT);
  renderTeeth('upperRight', U_RIGHT);
  renderTeeth('lowerLeft',  L_LEFT);
  renderTeeth('lowerRight', L_RIGHT);

  // Toolbar
  document.getElementById('btnClear')?.addEventListener('click', ()=>{
    selected.clear();
    document.querySelectorAll('.tooth-btn.active').forEach(el=>el.classList.remove('active'));
    sync();
  });
  document.getElementById('btnInvert')?.addEventListener('click', ()=>{
    const all = document.querySelectorAll('.tooth-btn');
    all.forEach(el=>{
      const c = el.dataset.code;
      if(selected.has(c)){ selected.delete(c); el.classList.remove('active'); }
      else{ selected.add(c); el.classList.add('active'); }
    });
    sync();
  });

  // Preload (nëse vjen nga edit)
  (function preload(){
    const raw = dhembiInput.value || dhembiDisplay.value || '';
    if(!raw) return;
    raw.split(',').map(s=>s.trim()).filter(Boolean).forEach(code=>{
      selected.add(code);
      document.querySelector(`.tooth-btn[data-code="${code}"]`)?.classList.add('active');
    });
    sync();
  })();

  // --- Autollogaritje Borgji: Vlera - Paguar ---
  const vlera  = document.getElementById('fldVlera');
  const paguar = document.getElementById('fldPaguar');
  const borgji = document.getElementById('fldBorgji');

  function toNum(x){ if(!x) return 0; return parseFloat(String(x).replace(',', '.')) || 0; }
  function recalcDebt(){
    if(!borgji.value || borgji.value.trim() === ''){
      const v = toNum(vlera.value);
      const p = toNum(paguar.value);
      const b = (v - p);
      borgji.value = isFinite(b) ? b.toFixed(2) : '';
    }
  }
  vlera?.addEventListener('input', recalcDebt);
  paguar?.addEventListener('input', recalcDebt);

  // --- Përfshirja në marrëveshje: çaktivizo çmimet kur është e shënuar ---
  const fldAgreement = document.getElementById('fldAgreement');
  const fldIncluded  = document.getElementById('fldIncluded');
  const priceRow     = document.getElementById('priceRow');

  function togglePriceFields(){
    const included = fldIncluded.checked;
    priceRow.querySelectorAll('input').forEach(inp=>{
      inp.value = included ? '' : inp.value;
      inp.disabled = included;
    });
    priceRow.classList.toggle('field-disabled', included);
  }

  fldIncluded?.addEventListener('change', togglePriceFields);
  fldAgreement?.addEventListener('change', ()=>{
    // Nëse ka marrëveshje të zgjedhur dhe user-i e shënon si e përfshirë → çmimi nuk nevojitet
    // (politikë e thjeshtë UI; mund ta heqësh nëse s’e do automatiken)
  });

  // në ngarkim, sigurohu që respektohet gjendja e checkbox-it (p.sh. kur është edit)
  togglePriceFields();
</script>

{% endblock %}
