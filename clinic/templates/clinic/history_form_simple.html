{% extends "clinic/base.html" %}
{% block title %}
    {% if historia %}
        Edito histori
    {% else %}
        Shto histori
    {% endif %}
    – {{ patient.emri_mbiemri }}
{% endblock %}
{% block content %}
    {% load static %}
    <!-- Header -->
    <div class="mb-5 flex items-center justify-between">
        <h2 class="text-xl font-semibold tracking-tight">
            {% if historia %}
                Edito histori
            {% else %}
                Shto histori
            {% endif %}
            për: {{ patient.emri_mbiemri }}
        </h2>
        <a href="{% url 'patient_detail' patient.id %}"
           class="px-3 py-2 border rounded bg-white hover:bg-gray-50 text-sm">Kthehu</a>
    </div>
    <form method="post"
          id="historyForm"
          class="bg-white border rounded-xl p-5 md:p-6 space-y-6">
        {% csrf_token %}
        <!-- 1) TË DHËNAT KRYESORE -->
        <section class="space-y-3">
            <h3 class="text-sm font-semibold text-gray-700">Të dhënat kryesore</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-xs text-gray-500 mb-1">Data</label>
                    <input type="hidden" name="data" value="{{ today|date:'Y-m-d' }}">
                    <input type="text"
                           value="{{ today|date:'d.m.Y' }}"
                           class="border rounded w-full p-2 bg-gray-100"
                           readonly>
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">Doktori</label>
                    <select name="doctor" class="border rounded w-full p-2" required>
                        <option value="">-- Zgjidh doktorin --</option>
                        <option value="Dr. Labi"
                                {% if historia and historia.doctor == 'Dr. Labi' %}selected{% endif %}>
                            Dr. Labi
                        </option>
                        <option value="Dr. Linda"
                                {% if historia and historia.doctor == 'Dr. Linda' %}selected{% endif %}>
                            Dr. Linda
                        </option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-xs text-gray-500 mb-1">Diagnoza</label>
                    <input name="diagnoza"
                           value="{{ historia.diagnoza|default_if_none:'' }}"
                           class="border rounded w-full p-2"
                           placeholder="p.sh. Caries profunda M2" />
                </div>
                <div class="md:col-span-4">
                    <label class="block text-xs text-gray-500 mb-1">Trajtimi</label>
                    <textarea name="trajtimi"
                              rows="3"
                              class="border rounded w-full p-2"
                              placeholder="p.sh. Ekstraksion, anestezi lok./ articaine 4% ...">{{ historia.trajtimi|default_if_none:'' }}</textarea>
                </div>
            </div>
        </section>
        <!-- 2) ODONTOGRAM -->
        <section class="space-y-4 select-none">
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-700">Odontogram (FDI)</h3>
                <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded border bg-gray-50 text-sm">
                    <span class="text-gray-500">Dhëmbët:</span>
                    <span id="teethBadge" class="font-medium">asnjë</span>
                </div>
            </div>
            <!-- Maxilla -->
            <div>
                <div class="mb-1 text-[11px] text-gray-500">Maxilla (sipër)</div>
                <div class="odontogram-row">
                    <div id="upperLeft"  class="odontogram-side"></div>
                    <div class="midline" aria-hidden="true"></div>
                    <div id="upperRight" class="odontogram-side"></div>
                </div>
            </div>
            <!-- Mandibula -->
            <div>
                <div class="mb-1 text-[11px] text-gray-500">Mandibula (poshtë)</div>
                <div class="odontogram-row">
                    <div id="lowerLeft"  class="odontogram-side"></div>
                    <div class="midline" aria-hidden="true"></div>
                    <div id="lowerRight" class="odontogram-side"></div>
                </div>
            </div>
            <style>
/* ====== ODONTOGRAM STYLE ====== */

.odontogram-row {
  display: flex;
  align-items: flex-end;
  justify-content: center;
  gap: 8px;
  flex-wrap: nowrap;
}

.odontogram-side {
  display: flex;
  gap: 6px;
  align-items: flex-end;
}

.midline {
  width: 5px;
  height: 3px;
  background: #e5e7eb;
  border-radius: 999px;
}

.tooth-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}

/* SVG Dhëmbët */
.tooth-img {
  height: 95px;
  width: auto;
  cursor: pointer;
  user-select: none;
  -webkit-user-drag: none;
  transition: transform .15s ease, filter .15s ease;
  filter: none;
}

/* Hover – pak ndriçim për feedback */
.tooth-img:hover {
  transform: scale(1.05);
  filter: brightness(1.05);
}

/* Selektim – vetëm vijat (stroke) bëhen jeshile */
.tooth-img.active {
  filter: invert(57%) sepia(36%) saturate(580%) hue-rotate(100deg) brightness(94%) contrast(90%);
}

/* Fallback (kur nuk ka SVG) */
.tooth-fallback {
  height: 95px;
  min-width: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  color: #374151;
  cursor: pointer;
  transition: transform .15s ease, color .15s ease;
}

.tooth-fallback:hover { 
  transform: scale(1.05);
  filter: brightness(1.05);
}

.tooth-fallback.active {
  color: #059669;
  font-weight: 600;
}

/* Numrat poshtë dhëmbëve */
.tooth-label {
  font-size: 10px;
  color: #6b7280;
  line-height: 1;
  user-select: none;
  transition: color .15s ease;
}

/* Ndryshim ngjyre për numrin aktiv */
.tooth-wrapper.active .tooth-label {
  color: #059669;
  font-weight: 600;
}

/* Numrat e maxillës – pak më poshtë për estetikë */
#upperLeft .tooth-label,
#upperRight .tooth-label {
  margin-top: 8px; /* provo 3–5 për ta rregulluar si të pëlqen vizualisht */
  display: block;
}

/* Mobile */
@media (max-width: 640px) {
  .odontogram-row { gap: 5px; }
  .odontogram-side { gap: 4px; }
  .tooth-img { height: 70px; }
  .tooth-fallback { height: 70px; min-width: 16px; font-size: 9px; }
  .tooth-label { font-size: 8px; }
  #upperLeft .tooth-label,
  #upperRight .tooth-label { margin-top: 3px; }
}
            </style>
            <input type="hidden"
                   id="dhembiInput"
                   name="dhembi"
                   value="{{ historia.dhembi|default_if_none:'' }}" />
            <input type="text"
                   id="dhembiDisplay"
                   class="border rounded w-full p-2"
                   placeholder="p.sh. 11,12,16"
                   value="{{ historia.dhembi|default_if_none:'' }}"
                   readonly />
            <div class="flex items-center gap-2 pt-1 text-sm">
                <button type="button"
                        id="btnClear"
                        class="px-3 py-1.5 rounded border bg-white hover:bg-gray-50">Pastro</button>
                <button type="button"
                        id="btnInvert"
                        class="px-3 py-1.5 rounded border bg-white hover:bg-gray-50">Inverto</button>
            </div>
        </section>
        <!-- 3) FINANCA -->
        <section class="space-y-3">
            <h3 class="text-sm font-semibold text-gray-700">Financa</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-xs text-gray-500 mb-1">Marrëveshje (opsionale)</label>
                    <select name="agreement_id"
                            id="fldAgreement"
                            class="border rounded w-full p-2">
                        <option value="">— pa marrëveshje —</option>
                        {% for a in patient.agreements.all %}
                            {% if a.status == "active" %}
                                <option value="{{ a.id }}">{{ a.title }} — Totali {{ a.total_amount }}€ (Balanca {{ a.balance }}€)</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    <p class="text-[11px] text-gray-500 mt-1">
                        Nëse zgjedh marrëveshje, ky shërbim do të shënohet automatikisht si i përfshirë.
                    </p>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox"
                           id="fldIncluded"
                           name="included_in_agreement"
                           value="1"
                           class="size-4">
                    <label for="fldIncluded" class="text-sm">E përfshirë në marrëveshje (pa çmim)</label>
                </div>
            </div>
            <div id="priceRow" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-xs text-gray-500 mb-1">Vlera</label>
                    <input name="vlera"
                           id="fldVlera"
                           value="{{ historia.vlera|default_if_none:'' }}"
                           class="border rounded w-full p-2"
                           placeholder="0.00" />
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">Paguar</label>
                    <input name="paguar"
                           id="fldPaguar"
                           value="{{ historia.paguar|default_if_none:'' }}"
                           class="border rounded w-full p-2"
                           placeholder="0.00" />
                </div>
            </div>
        </section>
        <!-- 4) VËREJTJE & VEPRIMET -->
        <section class="space-y-3">
            <div>
                <label class="block text-xs text-gray-500 mb-1">Vërejtje</label>
                <input name="verejtje"
                       value="{{ historia.verejtje|default_if_none:'' }}"
                       class="border rounded w-full p-2" />
            </div>
            <div class="flex items-center gap-3">
                <button class="px-4 py-2 bg-emerald-600 text-white rounded">
                    {% if historia %}
                        Ruaj ndryshimet
                    {% else %}
                        Ruaj
                    {% endif %}
                </button>
                <a href="{% url 'patient_detail' patient.id %}"
                   class="px-4 py-2 border rounded bg-white hover:bg-gray-50">Anulo</a>
            </div>
        </section>
    </form>
    <script>
  const svgBase = "{% static 'assets/img/' %}";
  const U_LEFT  = [18,17,16,15,14,13,12,11];
  const U_RIGHT = [21,22,23,24,25,26,27,28];
  const L_LEFT  = [48,47,46,45,44,43,42,41];
  const L_RIGHT = [31,32,33,34,35,36,37,38];
  const selected = new Set();
  const dhembiInput   = document.getElementById('dhembiInput');
  const dhembiDisplay = document.getElementById('dhembiDisplay');
  const badge         = document.getElementById('teethBadge');
  const HAS_SVG = new Set([
    11,12,13,14,15,16,17,18,
    21,22,23,24,25,26,27,28,
    31,32,33,34,35,36,37,38,
    41,42,43,44,45,46,47,48
  ]);

  function makeToothElement(code){
    const wrapper = document.createElement('div');
    wrapper.className = "tooth-wrapper";
    if (HAS_SVG.has(code)) {
      const img = document.createElement('img');
      img.src = svgBase + code + ".svg";
      img.alt = String(code);
      img.className = "tooth-img";
      img.dataset.code = String(code);
      img.addEventListener('click', ()=> toggle(img, wrapper));
      wrapper.appendChild(img);
    } else {
      const span = document.createElement('span');
      span.className = "tooth-fallback";
      span.textContent = String(code);
      span.dataset.code = String(code);
      span.addEventListener('click', ()=> toggle(span, wrapper));
      wrapper.appendChild(span);
    }
    const label = document.createElement('span');
    label.className = "tooth-label";
    label.textContent = code;
    wrapper.appendChild(label);
    return wrapper;
  }

  function mountRow(containerId, codes){
    const el = document.getElementById(containerId);
    codes.forEach(code=> el.appendChild(makeToothElement(code)));
  }

  function toggle(node, wrapper){
    const code = node.dataset.code;
    if (selected.has(code)) {
      selected.delete(code);
      node.classList.remove('active');
      wrapper?.classList.remove('active');
    } else {
      selected.add(code);
      node.classList.add('active');
      wrapper?.classList.add('active');
    }
    sync();
  }

  function sync(){
    const arr = Array.from(selected).map(Number).sort((a,b)=>a-b);
    const val = arr.join(',');
    dhembiInput.value = val;
    dhembiDisplay.value = val;
    badge.textContent = val || 'asnjë';
  }

  mountRow('upperLeft',  U_LEFT);
  mountRow('upperRight', U_RIGHT);
  mountRow('lowerLeft',  L_LEFT);
  mountRow('lowerRight', L_RIGHT);

  (function preload(){
    const raw = dhembiInput.value || dhembiDisplay.value || '';
    if (!raw) return;
    raw.split(',').map(s=>s.trim()).filter(Boolean).forEach(code=>{
      selected.add(code);
      document.querySelector(`[data-code="${code}"]`)?.classList.add('active');
      document.querySelector(`[data-code="${code}"]`)?.parentElement.classList.add('active');
    });
    sync();
  })();

  document.getElementById('btnClear').addEventListener('click', ()=>{
    selected.clear();
    document.querySelectorAll('[data-code].active').forEach(n=>{
      n.classList.remove('active');
      n.parentElement?.classList.remove('active');
    });
    sync();
  });

  document.getElementById('btnInvert').addEventListener('click', ()=>{
    document.querySelectorAll('[data-code]').forEach(n=>{
      const c = n.dataset.code;
      if (selected.has(c)) {
        selected.delete(c);
        n.classList.remove('active');
        n.parentElement?.classList.remove('active');
      } else {
        selected.add(c);
        n.classList.add('active');
        n.parentElement?.classList.add('active');
      }
    });
    sync();
  });

  const fldAgreement = document.getElementById('fldAgreement');
  const fldIncluded  = document.getElementById('fldIncluded');
  const priceRow     = document.getElementById('priceRow');
  const vlera        = document.getElementById('fldVlera');

  function togglePriceFields(){
    const included = fldIncluded.checked;
    priceRow.querySelectorAll('input').forEach(inp=>{
      if (included){ inp.value=''; }
      inp.disabled = included;
    });
    priceRow.classList.toggle('opacity-55', included);
    priceRow.classList.toggle('pointer-events-none', included);
  }

  fldAgreement.addEventListener('change', ()=>{
    fldIncluded.checked = !!fldAgreement.value;
    togglePriceFields();
  });
  fldIncluded.addEventListener('change', togglePriceFields);
  togglePriceFields();

  document.getElementById('historyForm').addEventListener('submit', function(e){
    if (!fldAgreement.value && (!vlera.value || parseFloat(vlera.value)<=0)){
      e.preventDefault();
      alert("Ju lutem shënoni vlerën e shërbimit ose zgjidhni një marrëveshje.");
    }
  });
    </script>
{% endblock %}
