{% extends "clinic/base.html" %}
{% block title %}
    {% if historia %}
        Edito histori
    {% else %}
        Shto histori
    {% endif %}
    – {{ patient.emri_mbiemri }}
{% endblock %}
{% block content %}
{% load static %}

<!-- HEADER -->
<div class="mb-5 flex items-center justify-between">
  <h2 class="text-xl font-semibold tracking-tight">
    {% if historia %}Edito histori{% else %}Shto histori{% endif %}
    për: {{ patient.emri_mbiemri }}
  </h2>
  <a href="{% url 'patient_detail' patient.id %}"
     class="px-3 py-2 border rounded bg-white hover:bg-gray-50 text-sm">Kthehu</a>
</div>

{% if parent %}
  <div class="mt-2 mb-4 p-3 rounded-lg bg-emerald-50 border border-emerald-200 text-sm text-emerald-700">
    <strong>Vazhdo trajtimin:</strong> {{ parent.diagnosis|default:"(pa diagnozë)" }}
    — {{ parent.treatment|default:"(pa trajtim)" }}
  </div>
{% endif %}

<form method="post" id="historyForm"
      class="bg-white border rounded-xl p-5 md:p-6 space-y-6">
  {% csrf_token %}

  <!-- 1) TË DHËNAT KRYESORE -->
  <section class="space-y-3">
    <h3 class="text-sm font-semibold text-gray-700">Të dhënat kryesore</h3>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label class="block text-xs text-gray-500 mb-1">Data</label>
        <input type="hidden" name="data" value="{{ today|date:'Y-m-d' }}">
        <input type="text" value="{{ today|date:'d.m.Y' }}"
               class="border rounded w-full p-2 bg-gray-100" readonly>
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Doktori</label>
        <select name="doctor" class="border rounded w-full p-2" required>
          <option value="">-- Zgjidh doktorin --</option>
          <option value="Dr. Labi" {% if historia and historia.doctor == 'Dr. Labi' %}selected{% endif %}>Dr. Labi</option>
          <option value="Dr. Linda" {% if historia and historia.doctor == 'Dr. Linda' %}selected{% endif %}>Dr. Linda</option>
        </select>
      </div>
      <div class="md:col-span-2">
        <label class="block text-xs text-gray-500 mb-1">Diagnoza</label>
        <input name="diagnoza" value="{{ historia.diagnoza|default_if_none:'' }}"
               class="border rounded w-full p-2"
               placeholder="p.sh. Caries profunda M2" />
      </div>
      <div class="md:col-span-4">
        <label class="block text-xs text-gray-500 mb-1">Trajtimi</label>
        <textarea name="trajtimi" rows="3" class="border rounded w-full p-2"
                  placeholder="p.sh. Ekstraksion, anestezi lok./ articaine 4% ...">{{ historia.trajtimi|default_if_none:'' }}</textarea>
      </div>
    </div>
  </section>

  <!-- 2) ODONTOGRAM -->
  <section class="space-y-4 select-none">
    <div class="flex items-center justify-between">
      <h3 class="text-sm font-semibold text-gray-700">Odontogram (FDI)</h3>
      <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded border bg-gray-50 text-sm">
        <span class="text-gray-500">Dhëmbët:</span>
        <span id="teethBadge" class="font-medium">asnjë</span>
      </div>
    </div>

    <!-- Maxilla -->
    <div>
      <div class="mb-1 text-[11px] text-gray-500">Maxilla (sipër)</div>
      <div class="odontogram-row">
        <div id="upperLeft"  class="odontogram-side"></div>
        <div class="midline" aria-hidden="true"></div>
        <div id="upperRight" class="odontogram-side"></div>
      </div>
    </div>

    <!-- Mandibula -->
    <div>
      <div class="mb-1 text-[11px] text-gray-500">Mandibula (poshtë)</div>
      <div class="odontogram-row">
        <div id="lowerLeft"  class="odontogram-side"></div>
        <div class="midline" aria-hidden="true"></div>
        <div id="lowerRight" class="odontogram-side"></div>
      </div>
    </div>

    <style>
      .odontogram-row {
        display: flex;
        align-items: flex-end;
        justify-content: center;
        gap: 8px;
        flex-wrap: nowrap;
      }
      .odontogram-side { display: flex; gap: 6px; align-items: flex-end; }
      .midline { width: 5px; height: 3px; background: #e5e7eb; border-radius: 999px; }
      .tooth-wrapper { display: flex; flex-direction: column; align-items: center; gap: 2px; }
      .tooth-img { height: 95px; cursor: pointer; transition: transform .15s ease, filter .15s ease; }
      .tooth-img:hover { transform: scale(1.05); filter: brightness(1.05); }
      .tooth-img.active { filter: invert(57%) sepia(36%) saturate(580%) hue-rotate(100deg) brightness(94%) contrast(90%); }
      .tooth-fallback { height: 95px; min-width: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #374151; cursor: pointer; transition: transform .15s ease, color .15s ease; }
      .tooth-fallback.active { color: #059669; font-weight: 600; }
      .tooth-label { font-size: 10px; color: #6b7280; user-select: none; }
      .tooth-wrapper.active .tooth-label { color: #059669; font-weight: 600; }
      #upperLeft .tooth-label, #upperRight .tooth-label { margin-top: 8px; display: block; }
      @media (max-width: 640px) {
        .tooth-img { height: 70px; }
        .tooth-fallback { height: 70px; min-width: 16px; font-size: 9px; }
        .tooth-label { font-size: 8px; }
        #upperLeft .tooth-label, #upperRight .tooth-label { margin-top: 3px; }
      }
    </style>

    <input type="hidden" id="dhembiInput" name="dhembi" value="{{ historia.dhembi|default_if_none:'' }}" />
    <input type="text" id="dhembiDisplay"
           class="border rounded w-full p-2" placeholder="p.sh. 11,12,16"
           value="{{ historia.dhembi|default_if_none:'' }}" readonly />
    <div class="flex items-center gap-2 pt-1 text-sm">
      <button type="button" id="btnClear" class="px-3 py-1.5 rounded border bg-white hover:bg-gray-50">Pastro</button>
      <button type="button" id="btnInvert" class="px-3 py-1.5 rounded border bg-white hover:bg-gray-50">Inverto</button>
    </div>
  </section>

  <!-- 3) PUNIM PROTETIKOR (radio & fusha) -->
  <section class="space-y-3">
    <h3 class="text-sm font-semibold text-gray-700">Punim Protetikor</h3>
    <div class="flex items-center gap-6">
      <label class="flex items-center gap-2 text-sm">
        <input type="radio" name="has_punim" value="po" id="radioPo"
               class="text-emerald-600 focus:ring-emerald-500">
        Po
      </label>
      <label class="flex items-center gap-2 text-sm">
        <input type="radio" name="has_punim" value="jo" id="radioJo"
               class="text-emerald-600 focus:ring-emerald-500" checked>
        Jo
      </label>
    </div>

    <div id="punimFields" class="hidden space-y-3 pt-2">
      <div>
        <label class="block text-xs text-gray-500 mb-1">Lloji i punimit</label>
        <textarea name="punim_protetikor" rows="2"
                  class="border rounded w-full p-2"
                  placeholder="p.sh. Kurorë zirkon, protezë, punim për molar ...">{{ historia.punim_protetikor|default_if_none:'' }}</textarea>
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Tekniku</label>
        <input name="tekniku"
               value="{{ historia.tekniku|default_if_none:'' }}"
               class="border rounded w-full p-2"
               placeholder="" />
      </div>
    </div>
  </section>

  <!-- 4) FINANCA -->
  <section class="space-y-3">
    <h3 class="text-sm font-semibold text-gray-700">Financa</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="md:col-span-2">
        <label class="block text-xs text-gray-500 mb-1">Marrëveshje (opsionale)</label>
        <select name="agreement_id" id="fldAgreement" class="border rounded w-full p-2">
          <option value="">— pa marrëveshje —</option>
          {% for a in patient.agreements.all %}
            {% if a.status == "active" %}
              <option value="{{ a.id }}">{{ a.title }} — Totali {{ a.total_amount }}€ (Balanca {{ a.balance }}€)</option>
            {% endif %}
          {% endfor %}
        </select>
        <p class="text-[11px] text-gray-500 mt-1">
          Nëse zgjedh marrëveshje, ky shërbim do të shënohet automatikisht si i përfshirë.
        </p>
      </div>
      <div class="flex items-center gap-2">
        <input type="checkbox" id="fldIncluded" name="included_in_agreement"
               value="1" class="size-4">
        <label for="fldIncluded" class="text-sm">E përfshirë në marrëveshje (pa çmim)</label>
      </div>
    </div>

    <div id="priceRow" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-xs text-gray-500 mb-1">Vlera</label>
        <input name="vlera" id="fldVlera"
               value="{{ historia.vlera|default_if_none:'' }}"
               class="border rounded w-full p-2" placeholder="0.00" />
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Paguar</label>
        <input name="paguar" id="fldPaguar"
               value="{{ historia.paguar|default_if_none:'' }}"
               class="border rounded w-full p-2" placeholder="0.00" />
      </div>
    </div>
  </section>

  <!-- 5) VËREJTJE & VEPRIMET -->
  <section class="space-y-3">
    <div>
      <label class="block text-xs text-gray-500 mb-1">Vërejtje</label>
      <input name="verejtje"
             value="{{ historia.verejtje|default_if_none:'' }}"
             class="border rounded w-full p-2" />
    </div>
    <div class="flex items-center gap-3">
      <button class="px-4 py-2 bg-emerald-600 text-white rounded">
        {% if historia %}Ruaj ndryshimet{% else %}Ruaj{% endif %}
      </button>
      <a href="{% url 'patient_detail' patient.id %}"
         class="px-4 py-2 border rounded bg-white hover:bg-gray-50">Anulo</a>
    </div>
  </section>
</form>


<!-- JS -->
<script>
  const svgBase = "{% static 'assets/img/' %}";
  const U_LEFT=[18,17,16,15,14,13,12,11],U_RIGHT=[21,22,23,24,25,26,27,28],
        L_LEFT=[48,47,46,45,44,43,42,41],L_RIGHT=[31,32,33,34,35,36,37,38];
  const selected=new Set(),dhembiInput=document.getElementById("dhembiInput"),
        dhembiDisplay=document.getElementById("dhembiDisplay"),
        badge=document.getElementById("teethBadge");
  const HAS_SVG=new Set([11,12,13,14,15,16,17,18,21,22,23,24,25,26,27,28,31,32,33,34,35,36,37,38,41,42,43,44,45,46,47,48]);
  function makeToothElement(code){const w=document.createElement("div");w.className="tooth-wrapper";
    if(HAS_SVG.has(code)){const i=document.createElement("img");i.src=svgBase+code+".svg";i.alt=code;i.className="tooth-img";i.dataset.code=code;i.addEventListener("click",()=>toggle(i,w));w.appendChild(i);}
    else{const s=document.createElement("span");s.className="tooth-fallback";s.textContent=code;s.dataset.code=code;s.addEventListener("click",()=>toggle(s,w));w.appendChild(s);}
    const l=document.createElement("span");l.className="tooth-label";l.textContent=code;w.appendChild(l);return w;}
  function mountRow(id,codes){const el=document.getElementById(id);codes.forEach(c=>el.appendChild(makeToothElement(c)));}
  function toggle(n,w){const c=n.dataset.code;if(selected.has(c)){selected.delete(c);n.classList.remove("active");w.classList.remove("active");}
    else{selected.add(c);n.classList.add("active");w.classList.add("active");}sync();}
  function sync(){const arr=Array.from(selected).map(Number).sort((a,b)=>a-b);const val=arr.join(",");dhembiInput.value=dhembiDisplay.value=val;badge.textContent=val||"asnjë";}
  mountRow("upperLeft",U_LEFT);mountRow("upperRight",U_RIGHT);mountRow("lowerLeft",L_LEFT);mountRow("lowerRight",L_RIGHT);
  (function preload(){const raw=dhembiInput.value||dhembiDisplay.value||"";if(!raw)return;raw.split(",").map(s=>s.trim()).filter(Boolean).forEach(c=>{selected.add(c);document.querySelector(`[data-code="${c}"]`)?.classList.add("active");document.querySelector(`[data-code="${c}"]`)?.parentElement.classList.add("active");});sync();})();
  document.getElementById("btnClear").addEventListener("click",()=>{selected.clear();document.querySelectorAll("[data-code].active").forEach(n=>{n.classList.remove("active");n.parentElement?.classList.remove("active");});sync();});
  document.getElementById("btnInvert").addEventListener("click",()=>{document.querySelectorAll("[data-code]").forEach(n=>{const c=n.dataset.code;if(selected.has(c)){selected.delete(c);n.classList.remove("active");n.parentElement?.classList.remove("active");}else{selected.add(c);n.classList.add("active");n.parentElement?.classList.add("active");}});sync();});

  const fldAgreement=document.getElementById("fldAgreement"),
        fldIncluded=document.getElementById("fldIncluded"),
        priceRow=document.getElementById("priceRow"),
        vlera=document.getElementById("fldVlera");
  function togglePriceFields(){const included=fldIncluded.checked;priceRow.querySelectorAll("input").forEach(inp=>{if(included)inp.value="";inp.disabled=included;});
    priceRow.classList.toggle("opacity-55",included);priceRow.classList.toggle("pointer-events-none",included);}
  fldAgreement.addEventListener("change",()=>{fldIncluded.checked=!!fldAgreement.value;togglePriceFields();});
  fldIncluded.addEventListener("change",togglePriceFields);togglePriceFields();

  document.getElementById("historyForm").addEventListener("submit", e=>{
    const vleraVal=parseFloat(vlera.value)||0;
    const paguarVal=parseFloat(document.getElementById("fldPaguar").value)||0;

    if(vleraVal===0 && paguarVal>0){
      e.preventDefault();
      alert("❌ Nuk mund të regjistrohet pagesë nëse vlera është 0.");
      return;
    }

    
    if(vleraVal===0 && paguarVal===0) return;
    if(fldIncluded.checked || fldAgreement.value) return;

    // ❌ Në raste tjera kërko vlerë ose marrëveshje
    if(!fldAgreement.value && vleraVal<=0 && paguarVal<=0){
      e.preventDefault();
      alert("Ju lutem shënoni vlerën e shërbimit ose zgjidhni një marrëveshje.");
    }
  });

  const radioPo=document.getElementById("radioPo"),radioJo=document.getElementById("radioJo"),punimFields=document.getElementById("punimFields");
  function togglePunimFields(){if(radioPo.checked){punimFields.classList.remove("hidden");}else{punimFields.querySelectorAll("input,textarea").forEach(el=>el.value="");punimFields.classList.add("hidden");}}
  radioPo.addEventListener("change",togglePunimFields);radioJo.addEventListener("change",togglePunimFields);
  document.addEventListener("DOMContentLoaded",()=>{const hasData=document.querySelector("textarea[name='punim_protetikor']").value.trim()||document.querySelector("input[name='tekniku']").value.trim();if(hasData){radioPo.checked=true;togglePunimFields();}});
</script>
{% endblock %}
