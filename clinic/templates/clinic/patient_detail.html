{% extends "clinic/base.html" %}
{% block title %}{{ patient.emri_mbiemri }}{% endblock %}
{% block content %}
    {% load custom_filters %}
    <!-- ============================= -->
    <!-- HERO / HEADER-->
    <!-- ============================= -->
    <section class="rounded-2xl mb-8 overflow-hidden shadow-lg bg-gradient-to-r from-emerald-600 to-emerald-500 text-white">
        <div class="p-6 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            <div class="flex items-center gap-4">
                <div class="size-14 rounded-full bg-white/15 backdrop-blur flex items-center justify-center ring-1 ring-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="size-7"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 7.5a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.5 19.5a7.5 7.5 0 1115 0v.375a.375.375 0 01-.375.375H4.875A.375.375 0 014.5 19.875V19.5z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold leading-tight">{{ patient.emri_mbiemri }}</h1>
                    <p class="text-sm text-white/90">Detajet e pacientit</p>
                </div>
            </div>
            <div class="flex flex-wrap gap-3">
                <a href="{% url 'add_history' patient.id %}"
                   class="px-4 py-2 bg-white text-emerald-700 rounded-xl font-medium flex items-center gap-2 shadow hover:bg-gray-50 transition">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="size-4"
                         fill="currentColor"
                         viewBox="0 0 24 24">
                        <path d="M12 5c.414 0 .75.336.75.75V11.25H18a.75.75 0 010 1.5h-5.25V18a.75.75 0 01-1.5 0v-5.25H6a.75.75 0 010-1.5h5.25V5.75c0-.414.336-.75.75-.75z" />
                    </svg>
                    Shto histori
                </a>
                <a href="{% url 'agreement_create' patient.id %}"
                   class="px-4 py-2 rounded-xl font-medium border border-white/30 bg-white/10 hover:bg-white/20 transition">
                    + Marrëveshje
                </a>
            </div>
        </div>
    </section>
    <!-- ============================= -->
    <!-- INFO + PËRMBLEDHJE -->
    <!-- ============================= -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
        <!-- Info pacienti -->
        <article class="lg:col-span-2 bg-white rounded-xl border p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="font-semibold text-lg text-gray-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="size-5 text-gray-500"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.75 7.5a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.5 19.5a7.5 7.5 0 1115 0v.375a.375.375 0 01-.375.375H4.875A.375.375 0 014.5 19.875V19.5z" />
                    </svg>
                    Të dhënat e pacientit
                </h2>
                <span class="px-3 py-1 text-xs rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200 font-medium">
                    Aktiv
                </span>
            </div>
            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-5 text-sm">
                <div>
                    <dt class="text-gray-500">Emri</dt>
                    <dd class="font-medium text-gray-800">
                        {{ patient.emri_mbiemri }}
                    </dd>
                </div>
                <div>
                    <dt class="text-gray-500">Data e lindjes</dt>
                    <dd class="font-medium text-gray-800">
                        {{ patient.data_e_lindjes }}
                    </dd>
                </div>
                <div>
                    <dt class="text-gray-500">Telefoni</dt>
                    <dd class="font-medium text-gray-800">
                        {{ patient.telefoni }}
                    </dd>
                </div>
                <div>
                    <dt class="text-gray-500">Email</dt>
                    <dd class="font-medium text-gray-800 break-all">
                        {{ patient.emaili }}
                    </dd>
                </div>
                <div class="sm:col-span-2">
                    <dt class="text-gray-500">Adresa</dt>
                    <dd class="font-medium text-gray-800">
                        {{ patient.adresa }}
                    </dd>
                </div>
                <div>
                    <dt class="text-gray-500">Numri i letërnjoftimit</dt>
                    <dd class="font-medium text-gray-800">
                        {{ patient.leternjoftimi|default:"—" }}
                    </dd>
                </div>
            </dl>
        </article>
        <!-- Përmbledhje -->
        <aside class="bg-white rounded-xl border p-6">
            <h2 class="font-semibold text-lg text-gray-800 mb-6 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="size-5 text-gray-500"
                     fill="none"
                     viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-2.21 0-4 1.79-4 4v4h8v-4c0-2.21-1.79-4-4-4zM6 12H4m16 0h-2" />
                </svg>
                Përmbledhje
            </h2>
            <div class="grid gap-4 text-sm">
                <div class="rounded-lg border p-4 bg-gray-50">
                    <p class="text-gray-500">Totali</p>
                    <p class="text-xl font-bold text-gray-800">{{ total_billed_new }}€</p>
                </div>
                <div class="rounded-lg border p-4 bg-gray-50">
                    <p class="text-gray-500">Paguar</p>
                    <p class="text-xl font-bold text-emerald-600">{{ total_paid_new }}€</p>
                </div>
                <div class="rounded-lg border p-4 bg-gray-50 flex items-center justify-between">
                    <div>
                        <p class="text-gray-500">Borxh</p>
                        <p class="text-xl font-bold {% if debt_new > 0 %}text-red-600{% else %}text-gray-700{% endif %}">{{ debt_new }}€</p>
                    </div>
                    {% if debt_new > 0 %}
                        <span class="px-2 py-0.5 text-xs rounded-full bg-red-50 text-red-700 border border-red-200">Në detyrim</span>
                    {% endif %}
                </div>
                <p class="text-xs text-gray-500">
                    Marrëveshje aktive: <span class="font-medium">{{ agreements_active|length }}</span>
                </p>
            </div>
        </aside>
    </section>
    <!-- ============================= -->
    <!-- HISTORIA (JASHTË MARRËVESHJEJE) -->
    <!-- ============================= -->
<section class="bg-white border rounded-xl overflow-hidden mb-10">
    <!-- Header -->
    <header class="px-6 py-4 border-b bg-gray-50 flex items-center justify-between">
        <div class="flex items-center gap-2 text-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="size-5 text-gray-500"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 12h6m-6 4h6M5 8h14M5 16h14M4 6h16a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2z" />
            </svg>
            <h3 class="font-semibold text-lg">Historia</h3>
        </div>
    </header>

    <!-- Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
            <thead class="bg-gray-100 text-gray-600 text-xs uppercase tracking-wide border-b">
                <tr>
                    <th class="px-4 py-3 text-left">Data</th>
                    <th class="px-4 py-3 text-left">Dhëmbi</th>
                    <th class="px-4 py-3 text-left">Diagnoza</th>
                    <th class="px-4 py-3 text-left">Trajtimi</th>
                    <th class="px-4 py-3 text-left">Çmimi</th>
                    <th class="px-4 py-3 text-left">Paguar</th>
                    <th class="px-4 py-3 text-left">Borxh</th>
                    <th class="px-4 py-3 text-left">Doktori</th>
                    <th class="px-4 py-3 text-left">Vërejtje</th>
                    <th class="px-4 py-3 text-left">Nga</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white">
                {% with non_agreement=care_histories_all %}
                    {% for h in non_agreement %}
                        {% if not h.agreement %}
                            <tr class="hover:bg-gray-50 transition">
                                <td class="px-4 py-3 whitespace-nowrap text-gray-700">{{ h.date }}</td>
                                <td class="px-4 py-3 whitespace-nowrap">{{ h.tooth }}</td>

                                <!-- Diagnoza -->
                                <td class="px-4 py-3">
                                    {% if h.diagnosis %}
                                        {{ h.diagnosis }}
                                    {% endif %}
                                </td>

                                <!-- Trajtimi + Punim Protetikor + Tekniku -->
                                <td class="px-4 py-3 align-top">
                                    {% if h.treatment %}
                                        {{ h.treatment }}
                                    {% endif %}
                                    {% if h.punim_protetikor or h.tekniku %}
                                        <div class="mt-1 text-xs text-gray-600 leading-snug">
                                            {% if h.punim_protetikor %}
                                                <div><span class="font-medium text-gray-700">Punim protetik:</span> {{ h.punim_protetikor }}</div>
                                            {% endif %}
                                            {% if h.tekniku %}
                                                <div><span class="font-medium text-gray-700">Tekniku:</span> {{ h.tekniku }}</div>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </td>

                                <!-- Çmimi -->
                                <td class="px-4 py-3 whitespace-nowrap">
                                    {% if h.included_in_agreement %}
                                        <span class="text-gray-400 italic">e përfshirë</span>
                                    {% else %}
                                        <span class="font-medium">{{ h.amount|default:"0.00" }}€</span>
                                    {% endif %}
                                </td>

                                <!-- Paguar -->
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <span class="px-2 py-0.5 rounded-lg bg-emerald-50 text-emerald-700 border border-emerald-200 text-xs font-medium">
                                        {{ h.paid_sum|default:"0.00" }}€
                                    </span>
                                </td>

                                <!-- Borxh -->
                                <td class="px-4 py-3 whitespace-nowrap">
                                    {% if h.debt_sum and h.debt_sum|floatformat != "0" %}
                                        <span class="px-2 py-0.5 rounded-lg bg-red-50 text-red-700 border border-red-200 text-xs font-medium">
                                            {{ h.debt_sum }}€
                                        </span>
                                    {% else %}
                                        <span class="text-gray-400 text-xs">0.00€</span>
                                    {% endif %}
                                </td>

                                <td class="px-4 py-3 whitespace-nowrap">{{ h.doctor }}</td>
                                <td class="px-4 py-3">
                                    {% if h.notes %}
                                        {{ h.notes }}
                                    {% endif %}
                                </td>

                                <td class="px-4 py-3 whitespace-nowrap text-gray-600">
                                    {% if h.created_by %}
                                        {{ h.created_by.get_full_name|default:h.created_by.username }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                        {% endif %}
                    {% empty %}
                        <tr>
                            <td colspan="10" class="px-4 py-6 text-center text-gray-400">S’ka histori.</td>
                        </tr>
                    {% endfor %}
                {% endwith %}
            </tbody>
        </table>
    </div>
</section>

<!-- ============================= -->
<!-- MARRËVESHJET + HISTORITË E TYRE -->
<!-- ============================= -->
<section class="bg-white border rounded-2xl overflow-hidden mb-10">
    <!-- Header -->
    <header class="px-6 py-5 border-b bg-gradient-to-r from-gray-50 to-white flex items-center justify-between">
        <div class="flex items-center gap-2 text-gray-800">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="size-5 text-gray-500"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 6v6h4m6 6V6a2 2 0 00-2-2H4a2 2 0 01-2 2v12a2 2 0 002 2h16a2 2 0 002-2z" />
            </svg>
            <h3 class="font-semibold text-lg">Marrëveshjet</h3>
        </div>
        <a href="{% url 'agreement_create' patient.id %}"
           class="text-green-700 hover:text-white border border-green-700 hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-xs sm:text-sm px-3 py-1.5 sm:px-5 sm:py-2.5 text-center me-2 mb-2">
            + Krijo marrëveshje
        </a>
    </header>

    <div class="p-6 space-y-6">
        {% if agreements_new %}
            {% for a in agreements_new %}
                <article x-data="{ open: false }" class="rounded-xl border border-gray-200 overflow-hidden">
                    <!-- Card Header -->
                    <div class="p-5 flex flex-col gap-4 md:flex-row md:items-center md:justify-between bg-gray-50 border-b">
                        <div class="space-y-2">
                            <h4 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     class="size-5 text-emerald-600"
                                     fill="none"
                                     viewBox="0 0 24 24"
                                     stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M17 9V7a5 5 0 00-10 0v2m10 0a2 2 0 012 2v7a2 2 0 01-2 2H7a2 2 0 01-2-2v-7a2 2 0 012-2m10 0H7" />
                                </svg>
                                {{ a.title }}
                            </h4>

                            <!-- ✅ Shfaq Vërejtjet e Marrëveshjes (notes) -->
                            {% if a.notes %}
                                <p class="text-sm text-gray-600 leading-snug">
                                    <span class="font-medium text-gray-700">Vërejtje:</span> {{ a.notes }}
                                </p>
                            {% endif %}

                            <div class="flex flex-wrap gap-2 text-sm">
                                <span class="px-2 py-1 rounded-full bg-gray-100 text-gray-700 border">
                                    Totali: <strong>{{ a.total_amount }}€</strong>
                                </span>
                                <span class="px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 border border-emerald-200">
                                    Paguar: <strong>{{ a.paid_sum }}€</strong>
                                </span>
                                <span class="px-2 py-1 rounded-full {% if a.bal_sum > 0 %}bg-red-100 text-red-700 border border-red-200{% else %}bg-gray-100 text-gray-500{% endif %}">
                                    Borxh: <strong>{{ a.bal_sum }}€</strong>
                                </span>
                                <span class="px-2 py-1 rounded-full text-xs uppercase font-semibold tracking-wide {% if a.status == 'active' %}bg-emerald-600 text-white{% elif a.status == 'closed' %}bg-gray-500 text-white{% else %}bg-amber-500 text-white{% endif %}">
                                    {{ a.get_status_display|default:a.status }}
                                </span>
                            </div>

                            <p class="text-xs text-gray-500">
                                {% if a.created_by %}
                                    Krijuar nga: <span class="font-medium">{{ a.created_by.get_full_name|default:a.created_by.username }}</span>
                                {% else %}
                                    Krijuar nga: -
                                {% endif %}
                                {% if a.created_at %}• {{ a.created_at|date:"Y-m-d H:i" }}{% endif %}
                                {% if a.updated_by %}• Përditësuar nga: {{ a.updated_by.get_full_name|default:a.updated_by.username }}{% endif %}
                            </p>
                        </div>

                        <!-- Veprimet -->
                        <div class="flex items-center gap-2">
                            {% if a.status == 'active' %}
                                {% if a.bal_sum <= 0 %}
                                    <a href="{% url 'agreement_close' a.id %}"
                                       class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm">
                                        Mbyll
                                    </a>
                                {% else %}
                                    <span class="px-3 py-1.5 rounded-lg bg-amber-100 text-amber-700 text-sm border border-amber-200">
                                        Mbetur: {{ a.bal_sum }}€
                                    </span>
                                    <button disabled
                                            class="px-4 py-2 rounded-lg bg-gray-100 text-gray-400 text-sm cursor-not-allowed">
                                        Mbyll
                                    </button>
                                {% endif %}
                            {% endif %}

                            <!-- Accordion toggle -->
                            <button @click="open = !open"
                                    type="button"
                                    class="px-3 py-1.5 rounded-lg border text-sm hover:bg-gray-100 transition flex items-center gap-1">
                                Historitë
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     class="size-4 text-gray-500 transition-transform"
                                     :class="{'rotate-90': open}"
                                     fill="none"
                                     viewBox="0 0 24 24"
                                     stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Historitë Accordion -->
                    <div x-show="open" x-collapse class="agreement-histories border-t">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-100 text-gray-600 text-xs uppercase tracking-wide">
                                <tr>
                                    <th class="px-4 py-3 text-left">Data</th>
                                    <th class="px-4 py-3 text-left">Dhëmbi</th>
                                    <th class="px-4 py-3 text-left">Diagnoza</th>
                                    <th class="px-4 py-3 text-left">Trajtimi</th>
                                    <th class="px-4 py-3 text-left">Çmimi</th>
                                    <th class="px-4 py-3 text-left">Doktori</th>
                                    <th class="px-4 py-3 text-left">Nga</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 bg-white">
                                {% for h in care_histories_all %}
                                    {% if h.agreement and h.agreement.id == a.id %}
                                        <tr class="hover:bg-gray-50 transition">
                                            <td class="px-4 py-3 whitespace-nowrap">{{ h.date }}</td>
                                            <td class="px-4 py-3 whitespace-nowrap">{{ h.tooth }}</td>

                                            <!-- Diagnoza -->
                                            <td class="px-4 py-3">
                                                {% if h.diagnosis %}
                                                    {{ h.diagnosis }}
                                                {% endif %}
                                            </td>

                                            <!-- Trajtimi -->
                                            <td class="px-4 py-3">
                                                {% if h.treatment %}
                                                    {{ h.treatment }}
                                                {% endif %}
                                            </td>

                                            <!-- Çmimi -->
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                {% if h.included_in_agreement %}
                                                    <span class="text-gray-400 italic">e përfshirë</span>
                                                {% else %}
                                                    {{ h.amount|default:"0.00" }}€
                                                {% endif %}
                                            </td>

                                            <td class="px-4 py-3 whitespace-nowrap">{{ h.doctor }}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-gray-600">
                                                {% if h.created_by %}
                                                    {{ h.created_by.get_full_name|default:h.created_by.username }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% empty %}
                                    <tr>
                                        <td colspan="7" class="px-4 py-6 text-center text-gray-400">—</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </article>
            {% endfor %}
        {% else %}
            <div class="text-gray-500 px-2">S’ka marrëveshje.</div>
        {% endif %}
    </div>
</section>
    <!-- ============================= -->
    <!-- SHTO PAGESË -->
    <!-- ============================= -->
    <section class="bg-white border rounded-xl overflow-hidden mb-10">
        <!-- Header -->
        <header class="px-6 py-4 border-b bg-gray-50 flex items-center gap-2 text-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="size-5 text-gray-500"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-2.21 0-4 1.79-4 4v4h8v-4c0-2.21-1.79-4-4-4zM6 12H4m16 0h-2" />
            </svg>
            <h3 class="font-semibold text-lg">Shto pagesë</h3>
        </header>
        <!-- Form -->
        <form method="post"
              action="{% url 'add_payment' patient.id %}"
              class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
            {% csrf_token %}
            <!-- Shuma -->
            <div>
                <label class="block text-gray-600 mb-1 font-medium">Shuma *</label>
                <input type="number"
                       step="0.01"
                       name="amount"
                       required
                       class="w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
            </div>
            <!-- Metoda -->
            <div>
                <label class="block text-gray-600 mb-1 font-medium">Metoda</label>
                <select name="method"
                        class="w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                    <option value="cash">Cash</option>
                    <option value="card">Kartelë</option>
                    <option value="transfer">Transfer</option>
                    <option value="other">Tjetër</option>
                </select>
            </div>
            <!-- Për Histori (ops.) -->
            <div class="md:col-span-2 rounded-lg border p-4 bg-gray-50">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-gray-600 font-medium">Për histori (ops.)</label>
                    <div class="flex items-center gap-2">
                        <button type="button"
                                id="btnSelectAll"
                                class="px-3 py-1 text-xs rounded border hover:bg-gray-100 transition">
                            Zgjidh të gjitha
                        </button>
                        <button type="button"
                                id="btnClearAll"
                                class="px-3 py-1 text-xs rounded border hover:bg-gray-100 transition">
                            Hiq të gjitha
                        </button>
                    </div>
                </div>
                <div class="mt-3 max-h-56 overflow-auto divide-y divide-gray-200 bg-white rounded border">
                    {% for h in unpaid_histories %}
                        <label class="flex items-start gap-3 p-3 hover:bg-gray-50 transition">
                            <input type="checkbox"
                                   name="history_ids"
                                   value="{{ h.id }}"
                                   data-debt="{{ h.debt_sum }}"
                                   class="mt-1 size-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                            <div class="flex-1">
                                <div class="font-medium text-sm text-gray-800">{{ h.date }} — {{ h.diagnosis|default:"(pa përshkrim)" }}</div>
                                <div class="text-xs text-gray-500">
                                    Çmimi: {{ h.amount|default:"0.00" }}€ •
                                    Paguar: {{ h.paid_sum|default:"0.00" }}€ •
                                    Borxh: <span class="font-semibold text-red-600">{{ h.debt_sum }}</span>€
                                </div>
                            </div>
                        </label>
                    {% empty %}
                        <div class="text-sm text-gray-500 p-3">S’ka histori me borxh.</div>
                    {% endfor %}
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    Zgjidh një ose disa histori. Shuma do të ndahet automatikisht sipas borxhit, nga më e vjetra te më e reja.
                </p>
                <div id="selectionInfo" class="mt-2 text-xs font-medium text-gray-700">Të zgjedhura: 0 • Borxh total: 0.00€</div>
            </div>
            <!-- Marrëveshje -->
            <div>
                <label class="block text-gray-600 mb-1 font-medium">Ose për Marrëveshje (ops.)</label>
                <select name="agreement_id"
                        class="w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                    <option value="">—</option>
                    {% for a in agreements_active %}
                        <option value="{{ a.id }}">{{ a.title }} (borxhi mbetur: {{ a.bal_sum }}€)</option>
                    {% endfor %}
                </select>
                <p class="text-xs text-gray-500 mt-1">Përdore kur pagesa është këst/akontim për marrëveshje.</p>
            </div>
            <!-- Shënime -->
            <div class="md:col-span-2">
                <label class="block text-gray-600 mb-1 font-medium">Shënime</label>
                <input type="text"
                       name="notes"
                       class="w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                       placeholder="opsionale">
            </div>
            <!-- Submit -->
            <div class="md:col-span-2">
                <button type="submit"
                        class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="size-4"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Ruaj pagesën
                </button>
            </div>
        </form>
    </section>
    <!-- ============================= -->
    <!-- HISTORIA E PAGESAVE -->
    <!-- ============================= -->
    <section class="bg-white border rounded-xl overflow-hidden mb-10">
        <!-- Header -->
        <header class="px-6 py-4 border-b bg-gray-50 flex items-center justify-between">
            <div class="flex items-center gap-2 text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="size-5 text-gray-500"
                     fill="none"
                     viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h10M4 18h6" />
                </svg>
                <h3 class="font-semibold text-lg">Historia e Pagesave</h3>
            </div>
            <div class="flex flex-wrap items-center gap-2 text-sm">
                <span class="px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200 font-medium">
                    Totali i paguar: <strong>{{ total_paid_new }}€</strong>
                </span>
                <span class="px-3 py-1 rounded-full bg-amber-50 text-amber-700 border border-amber-200 font-medium">
                    Borxhi aktiv: <strong>{{ total_agreements_balance }}€</strong>
                </span>
            </div>
        </header>
        <!-- Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="bg-gray-100 text-gray-600 text-xs uppercase tracking-wide border-b">
                    <tr>
                        <th class="px-4 py-3 text-left">#</th>
                        <th class="px-4 py-3 text-left">Data</th>
                        <th class="px-4 py-3 text-left">Shuma</th>
                        <th class="px-4 py-3 text-left">Metoda</th>
                        <th class="px-4 py-3 text-left">Për</th>
                        <th class="px-4 py-3 text-left">Nga</th>
                        <th class="px-4 py-3 text-left">Shënime</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white">
                    {% for p in payments_new %}
                        <tr class="hover:bg-gray-50 transition">
                            <td class="px-4 py-3 whitespace-nowrap text-gray-700">#{{ p.id }}</td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                {% if p.created_at %}
                                    {{ p.created_at|date:"Y-m-d H:i" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap font-semibold text-emerald-600">{{ p.amount }}€</td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="px-2 py-0.5 rounded bg-gray-100 border text-gray-700 text-xs">
                                    {{ p.get_method_display|default:p.method }}
                                </span>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                {% if p.history %}
                                    <span class="text-gray-700">Histori:</span> {{ p.history.diagnosis|default:"—" }}
                                {% elif p.agreement %}
                                    <span class="text-gray-700">Marrëveshje:</span> {{ p.agreement.title }}
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-gray-600">
                                {% if p.created_by %}
                                    {{ p.created_by.get_full_name|default:p.created_by.username }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-gray-700">{{ p.notes|default:"" }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7" class="px-4 py-6 text-center text-gray-400">S’ka pagesa.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    <!-- ============================= -->
    <!-- DOKUMENTE -->
    <!-- ============================= -->
    <section x-data="{ open: true }"
             class="bg-white border rounded-xl overflow-hidden mb-10">
        <!-- Header -->
        <header @click="open = !open"
                class="px-6 py-4 border-b bg-gray-50 flex items-center justify-between cursor-pointer select-none">
            <div class="flex items-center gap-2 text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="size-5 text-gray-500"
                     fill="none"
                     viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <h3 class="font-semibold text-lg">Dokumente</h3>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="size-5 text-gray-500 transition-transform duration-300"
                 :class="{ 'rotate-90': open }"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
        </header>
        <!-- Body -->
        <div x-show="open" x-collapse class="p-6 space-y-6">
            <!-- Upload Form -->
            <form method="post"
                  enctype="multipart/form-data"
                  action="{% url 'upload_document' patient.id %}"
                  id="uploadForm"
                  class="flex justify-end">
                {% csrf_token %}
                <label class="cursor-pointer inline-flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg shadow hover:bg-emerald-700 transition text-sm font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="size-4"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5-5m0 0l5 5m-5-5v12" />
                    </svg>
                    Ngarko dokument
                    <input type="file"
                           name="document"
                           accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx"
                           class="hidden"
                           onchange="this.form.submit()">
                </label>
            </form>
            <!-- Lista Dokumenteve -->
            <div class="overflow-x-auto border rounded-lg">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-100 text-gray-600 text-xs uppercase tracking-wide border-b">
                        <tr>
                            <th class="px-4 py-3 text-left">#</th>
                            <th class="px-4 py-3 text-left">Emri</th>
                            <th class="px-4 py-3 text-left">Tipi</th>
                            <th class="px-4 py-3 text-left">Ngarkuar më</th>
                            <th class="px-4 py-3 text-left">Nga</th>
                            <th class="px-4 py-3 text-right">Veprime</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 bg-white">
                        {% for doc in documents %}
                            <tr class="hover:bg-gray-50 transition">
                                <td class="px-4 py-3 whitespace-nowrap">#{{ forloop.counter }}</td>
                                <td class="px-4 py-3">{{ doc.file.name|basename }}</td>
                                <td class="px-4 py-3">{{ doc.file|extension }}</td>
                                <td class="px-4 py-3 whitespace-nowrap">{{ doc.uploaded_at|date:"Y-m-d H:i" }}</td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    {% if doc.uploaded_by %}
                                        {{ doc.uploaded_by.get_full_name|default:doc.uploaded_by.username }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 text-right whitespace-nowrap flex items-center gap-2 justify-end">
                                    <a href="{{ doc.file.url }}"
                                       download
                                       class="px-3 py-1.5 rounded-lg border hover:bg-gray-50 text-sm text-gray-700">
                                        Shkarko
                                    </a>
                                    <form method="post"
                                          action="{% url 'delete_patient_document' doc.id %}"
                                          onsubmit="return confirm('A je i sigurt që dëshiron ta fshish këtë dokument?');">
                                        {% csrf_token %}
                                        <button type="submit"
                                                class="px-3 py-1.5 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 text-sm">
                                            Fshij
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="6" class="px-4 py-6 text-center text-gray-400">S’ka dokumente.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>
    <!-- ============================= -->
    <!-- HISTORITË (ARKIVA) - COLLAPSIBLE -->
    <!-- ============================= -->
    <section x-data="{ open: false }"
             class="bg-white border rounded-xl overflow-hidden mb-6">
        <header class="px-6 py-4 border-b flex items-center justify-between cursor-pointer select-none bg-gray-50 hover:bg-gray-100 transition"
                @click="open = !open">
            <div class="flex items-center gap-2 text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg"
                     :class="{'rotate-90': open}"
                     class="size-4 transition-transform text-gray-500"
                     fill="none"
                     viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
                <h3 class="font-semibold text-lg">Historitë (Arkiva)</h3>
            </div>
            <span class="text-xs text-gray-500">{{ historias|length }} regjistrime</span>
        </header>
        <div x-show="open" x-collapse>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-100 text-gray-600 text-xs uppercase tracking-wide border-b">
                        <tr>
                            <th class="px-4 py-3 text-left">Data</th>
                            <th class="px-4 py-3 text-left">Dhëmbi</th>
                            <th class="px-4 py-3 text-left">Diagnoza</th>
                            <th class="px-4 py-3 text-left">Trajtimi</th>
                            <th class="px-4 py-3 text-left">Vlera</th>
                            <th class="px-4 py-3 text-left">Paguar</th>
                            <th class="px-4 py-3 text-left">Borxh</th>
                            <th class="px-4 py-3 text-left">Doktori</th>
                            <th class="px-4 py-3 text-right">Veprime</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 bg-white">
                        {% for h in historias %}
                            <tr class="hover:bg-gray-50 cursor-pointer"
                                data-href="{% url 'history_detail' h.id %}">
                                <td class="px-4 py-3 whitespace-nowrap">{{ h.data }}</td>
                                <td class="px-4 py-3">{{ h.dhembi }}</td>
                                <td class="px-4 py-3">{{ h.diagnoza }}</td>
                                <td class="px-4 py-3">{{ h.trajtimi }}</td>
                                <td class="px-4 py-3 whitespace-nowrap">{{ h.vlera }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-emerald-700 font-medium">{{ h.paguar }}</td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    {% if h.borgji and h.borgji|floatformat != "0" %}
                                        <span class="inline-flex items-center gap-1 text-red-600 font-medium">
                                            <span class="size-2 rounded-full bg-red-500"></span>{{ h.borgji }}
                                        </span>
                                    {% else %}
                                        <span class="text-gray-400">0</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap">{{ h.doctor }}</td>
                                {% if request.user.is_admin %}
                                <td class="px-4 py-3 text-right whitespace-nowrap">
                                    <a href="{% url 'edit_history' h.id %}"
                                       class="px-2 py-1 text-xs rounded border hover:bg-gray-50 transition">Edito</a>
                                    <form method="post"
                                          action="{% url 'delete_history' h.id %}"
                                          class="inline-block ml-1"
                                          onsubmit="return confirm('A je i sigurt që dëshiron ta fshish këtë histori?');">
                                        {% csrf_token %}
                                        <button type="submit"
                                                class="px-2 py-1 text-xs rounded border border-red-200 text-red-600 hover:bg-red-50 transition">
                                            Fshij
                                        </button>
                                    </form>
                                </td>
                                {% endif %}
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="9" class="px-4 py-6 text-center text-gray-400">Nuk ka histori.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>
    <!-- ============================= -->
    <!-- ORTODONCI (ARKIVA) - COLLAPSIBLE -->
    <!-- ============================= -->
    <section x-data="{ open: false }"
             class="bg-white border rounded-xl overflow-hidden mb-6">
        <header class="px-6 py-4 border-b flex items-center justify-between cursor-pointer bg-gray-50 hover:bg-gray-100 transition"
                @click="open = !open">
            <div class="flex items-center gap-2 text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg"
                     :class="{'rotate-90': open}"
                     class="size-4 transition-transform text-gray-500"
                     fill="none"
                     viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
                <h3 class="font-semibold text-lg">Ortodonci (Arkiva)</h3>
            </div>
            <span class="text-xs text-gray-500">{{ ortho_histories|length }} regjistrime</span>
        </header>
        <div x-show="open" x-collapse>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-100 text-gray-600 text-xs uppercase tracking-wide border-b">
                        <tr>
                            <th class="px-4 py-3 text-left">Data</th>
                            <th class="px-4 py-3 text-left">Diagnoza</th>
                            <th class="px-4 py-3 text-left">Trajtimi</th>
                            <th class="px-4 py-3 text-left">Vlera</th>
                            <th class="px-4 py-3 text-left">Paguar</th>
                            <th class="px-4 py-3 text-left">Borxh</th>
                            <th class="px-4 py-3 text-left">Doktori</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 bg-white">
                        {% for h in ortho_histories %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 whitespace-nowrap">{{ h.data }}</td>
                                <td class="px-4 py-3">{{ h.diagnoza }}</td>
                                <td class="px-4 py-3">{{ h.trajtimi }}</td>
                                <td class="px-4 py-3 whitespace-nowrap">{{ h.vlera }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-emerald-700 font-medium">{{ h.paguar }}</td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    {% if h.borgji and h.borgji|floatformat != "0" %}
                                        <span class="inline-flex items-center gap-1 text-red-600 font-medium">
                                            <span class="size-2 rounded-full bg-red-500"></span>{{ h.borgji }}
                                        </span>
                                    {% else %}
                                        <span class="text-gray-400">0</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap">{{ h.doctor }}</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="7" class="px-4 py-6 text-center text-gray-400">Nuk ka të dhëna.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>
    <!-- ============================= -->
    <!-- PËRMBLEDHJE FINANCIARE (ARKIVA) - COLLAPSIBLE -->
    <!-- ============================= -->
    <section x-data="{ open: false }"
             class="bg-white border rounded-xl overflow-hidden mb-10">
        <header class="px-6 py-4 border-b flex items-center justify-between cursor-pointer bg-gray-50 hover:bg-gray-100 transition"
                @click="open = !open">
            <div class="flex items-center gap-2 text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg"
                     :class="{'rotate-90': open}"
                     class="size-4 transition-transform text-gray-500"
                     fill="none"
                     viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
                <h2 class="font-semibold text-lg">Përmbledhje financiare (Arkiva)</h2>
            </div>
        </header>
        <div x-show="open" x-collapse class="p-6">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                <div class="rounded-xl border p-4 bg-gray-50">
                    <div class="text-gray-500">Totali</div>
                    <div class="text-xl font-bold">{{ total_vlera }}</div>
                </div>
                <div class="rounded-xl border p-4 bg-gray-50">
                    <div class="text-gray-500">Paguar</div>
                    <div class="text-xl font-bold text-emerald-600">{{ total_paguar }}</div>
                </div>
                <div class="rounded-xl border p-4 bg-gray-50">
                    <div class="text-gray-500">Borxh</div>
                    <div class="text-xl font-bold text-red-600">{{ total_borgji }}</div>
                </div>
            </div>
        </div>
    </section>
    <script src="//unpkg.com/alpinejs" defer></script>
    <script>
  document.addEventListener('click', function (e) {
    const stop = e.target.closest('.click-stop');
    if (stop) return;
    const row = e.target.closest('tr[data-href]');
    if (row) window.location.href = row.dataset.href;
  });
  document.addEventListener('keydown', function (e) {
    if ((e.key === 'Enter' || e.key === ' ') && document.activeElement?.matches('tr[data-href]')) {
      e.preventDefault();
      window.location.href = document.activeElement.dataset.href;
    }
  });
    </script>
    <!-- Checkbox selector (pagesa për disa histori) -->
    <script>
(function(){
  const boxes = Array.from(document.querySelectorAll('input[name="history_ids"]'));
  const info  = document.getElementById('selectionInfo');
  const selAll = document.getElementById('btnSelectAll');
  const clrAll = document.getElementById('btnClearAll');

  function updateInfo(){
    let c = 0, s = 0;
    boxes.forEach(cb=>{
      if(cb.checked){
        c++;
        s += parseFloat(cb.dataset.debt || '0') || 0;
      }
    });
    if(info) info.textContent = `Të zgjedhura: ${c} • Borxh total: ${s.toFixed(2)}€`;
  }

  boxes.forEach(cb=>cb.addEventListener('change', updateInfo));
  selAll?.addEventListener('click', ()=>{ boxes.forEach(cb=>cb.checked = true); updateInfo(); });
  clrAll?.addEventListener('click', ()=>{ boxes.forEach(cb=>cb.checked = false); updateInfo(); });

  updateInfo();
})();
    </script>
{% endblock %}
